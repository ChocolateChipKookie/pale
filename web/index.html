<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Pale - Test</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
        }
        #log {
            background: #1a1a1a;
            color: #0f0;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            margin: 0.5rem;
            padding: 0.5rem 1rem;
        }
        canvas {
            border: 1px solid #333;
            display: block;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <h1>Pale WASM Test</h1>

    <div>
        <button id="loadBtn">Load Module</button>
        <button id="createBtn" disabled>Create Context</button>
        <button id="destroyBtn" disabled>Destroy Context</button>
    </div>

    <canvas id="canvas" width="256" height="256"></canvas>

    <div id="log"></div>

    <script src="pale.js"></script>
    <script>
        const logEl = document.getElementById('log');
        const loadBtn = document.getElementById('loadBtn');
        const createBtn = document.getElementById('createBtn');
        const destroyBtn = document.getElementById('destroyBtn');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function log(msg) {
            const time = new Date().toISOString().substr(11, 12);
            logEl.textContent += `[${time}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // Draw a test pattern on the canvas
        function drawTestPattern() {
            const imageData = ctx.createImageData(256, 256);
            for (let y = 0; y < 256; y++) {
                for (let x = 0; x < 256; x++) {
                    const i = (y * 256 + x) * 4;
                    imageData.data[i] = x;       // R
                    imageData.data[i + 1] = y;   // G
                    imageData.data[i + 2] = 128; // B
                    imageData.data[i + 3] = 255; // A
                }
            }
            ctx.putImageData(imageData, 0, 0);
            return imageData;
        }

        function onModuleReady() {
            log('Module ready');
            log(`Exported functions: ${Object.keys(Module).filter(k => k.startsWith('_pale')).join(', ')}`);
            loadBtn.disabled = true;
            createBtn.disabled = false;
        }

        // Module is a global created by pale.js
        // Check if already initialized, otherwise wait for callback
        loadBtn.onclick = () => {
            log('Checking module status...');
            if (Module.calledRun) {
                onModuleReady();
            } else {
                log('Waiting for WASM to initialize...');
                Module.onRuntimeInitialized = onModuleReady;
            }
        };

        createBtn.onclick = () => {
            log('Drawing test pattern...');
            const imageData = drawTestPattern();

            log('Allocating pixel buffer in WASM memory...');
            const pixelCount = 256 * 256 * 4;
            const pixelPtr = Module._malloc(pixelCount);
            Module.HEAPU8.set(imageData.data, pixelPtr);

            log('Calling pale_create...');
            const seed = BigInt(Date.now());
            const result = Module._pale_create(pixelPtr, 256, 256, 1000, seed);
            console.log(result);
            if (result === 0) {
                log('Context created successfully (returned null)');
                createBtn.disabled = true;
                destroyBtn.disabled = false;
            } else {
                // Result is a pointer to an error string
                const errorMsg = Module.UTF8ToString(result);
                log(`Error creating context: ${errorMsg}`);
            }

            // Free the temporary pixel buffer (pale_create copies the data)
            Module._free(pixelPtr);
            log('Freed temporary pixel buffer');
        };

        destroyBtn.onclick = () => {
            log('Calling pale_destroy...');
            Module._pale_destroy();
            log('Context destroyed');
            createBtn.disabled = false;
            destroyBtn.disabled = true;
        };

        log('Page loaded. Click "Load Module" to start.');
    </script>
</body>
</html>
