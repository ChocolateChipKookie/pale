<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Pale - Test</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
        }
        #log {
            background: #1a1a1a;
            color: #0f0;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            margin: 0.5rem;
            padding: 0.5rem 1rem;
        }
        canvas {
            border: 1px solid #333;
            display: block;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <h1>Pale WASM Test</h1>

    <div>
        <button id="loadBtn">Load Module</button>
        <button id="createBtn" disabled>Create Context</button>
        <button id="runBtn" disabled>Run</button>
        <button id="destroyBtn" disabled>Destroy Context</button>
        <input type="file" id="imageInput" accept="image/*" disabled>
    </div>

    <canvas id="canvas" width="256" height="256"></canvas>

    <div id="log"></div>

    <script src="pale.js"></script>
    <script>
        const logEl = document.getElementById('log');
        const loadBtn = document.getElementById('loadBtn');
        const createBtn = document.getElementById('createBtn');
        const runBtn = document.getElementById('runBtn');
        const destroyBtn = document.getElementById('destroyBtn');
        const imageInput = document.getElementById('imageInput');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        var width = 256;
        var height = 256;
        var channels = 4;
        var zigContext = null;

        function log(msg) {
            const time = new Date().toISOString().substr(11, 12);
            logEl.textContent += `[${time}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function readError(msg) {
            const len = Module._pale_get_error_len();
            const ptr = Module._pale_get_error_ptr();
            const errorBytes = Module.HEAPU8.subarray(ptr, ptr + len);
            const errorMsg = new TextDecoder().decode(errorBytes);
            Module._pale_clear_error();
            return errorMsg;
        }

        // Draw a test pattern on the canvas
        function drawTestPattern() {
            const imageData = ctx.createImageData(width, height);
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = (y * width + x) * 4;
                    imageData.data[i] = x;       // R
                    imageData.data[i + 1] = y;   // G
                    imageData.data[i + 2] = 128; // B
                    imageData.data[i + 3] = 255; // A
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        function onModuleReady() {
            log('Module ready');
            log(`Exported functions: ${Object.keys(Module).filter(k => k.startsWith('_pale')).join(', ')}`);
            loadBtn.disabled = true;
            createBtn.disabled = false;
            imageInput.disabled = false;
            log('Drawing test pattern...');
            const imageData = drawTestPattern();

        }

        // Module is a global created by pale.js
        // Check if already initialized, otherwise wait for callback
        loadBtn.onclick = () => {
            log('Checking module status...');
            if (Module.calledRun) {
                onModuleReady();
            } else {
                log('Waiting for WASM to initialize...');
                Module.onRuntimeInitialized = onModuleReady;
            }
        };

        createBtn.onclick = () => {
            const imageData = ctx.getImageData(0, 0, width, height);

            log('Allocating pixel buffer in WASM memory...');
            const pixelCount = width * height * channels;
            const pixelPtr = Module._malloc(pixelCount);
            Module.HEAPU8.set(imageData.data, pixelPtr);

            log('Calling pale_create...');
            const seed = BigInt(Date.now());
            const result = Module._pale_create(pixelPtr, width, height, 1000, seed);
            if (result !== 0) {
                log('Context created successfully');
                createBtn.disabled = true;
                imageInput.disabled = true;
                destroyBtn.disabled = false;
                runBtn.disabled = false;
                zigContext = result;
            } else {
                const errorMsg = readError();
                log(`Error creating context: ${errorMsg}`);
            }

            // Free the temporary pixel buffer (pale_create copies the data)
            Module._free(pixelPtr);
            log('Freed temporary pixel buffer');
        };

        destroyBtn.onclick = () => {
            log('Calling pale_destroy...');
            const result = Module._pale_destroy(zigContext);
            if (result === 0) {
                const errorMsg = readError();
                log(`Error creating context: ${errorMsg}`);
                return;
            }
            log('Context destroyed');
            createBtn.disabled = false;
            imageInput.disabled = false;
            destroyBtn.disabled = true;
            runBtn.disabled = true;
        };

        runBtn.onclick = () => {
            log('Running 10000 iterations');
            const result = Module._pale_run_steps(zigContext, 10000);
            if (result === 0) {
                const errorMsg = readError();
                log(`Error running: ${errorMsg}`);
                return;
            }

            const dataPtr = Module._pale_get_best_image(zigContext);
            if (dataPtr === 0){
                const errorMsg = readError();
                log(`Error running: ${errorMsg}`);
                return;
            }
            const dataLen = width * height * channels;
            const imageData = ctx.createImageData(width, height);
            imageData.data.set(Module.HEAPU8.subarray(dataPtr, dataPtr + dataLen));
            ctx.putImageData(imageData, 0, 0);
        };

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                width = img.width;
                height = img.height;
            };
            img.src = URL.createObjectURL(file);
        });

        log('Page loaded. Click "Load Module" to start.');
    </script>
</body>
</html>
